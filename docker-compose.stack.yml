services:

  redis:
    image: docker.io/valkey/valkey:8-alpine
    restart: always
    volumes:
      - redis:/data:rw
    command: ["valkey-server", "--save", "60", "1", "--loglevel", "warning"]
    healthcheck:
      test: valkey-cli ping
      interval: 10s
      timeout: 30s
      retries: 5
      start_period: 3s

  pgsql:
    image: docker.io/postgres:17-alpine
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - pgsql:/var/lib/postgresql/data:rw
    healthcheck:
      test: pg_isready -q -t 2 -U $$POSTGRES_USER
      interval: 10s
      timeout: 30s
      retries: 5
      start_period: 3s

  pubsub:
    build:
      context: services/pubsub-emulator
      target: export

  pubsub-emulator-ui:
    image: ghcr.io/neoscript/pubsub-emulator-ui:2025.02.25
    environment:
      - PUBSUB_EMULATOR_HOST=pubsub.deps.internal:8432
  
  firestore:
    build:
      context: services/firebase
    environment:
      PROJECT_ID: demo-tao
  es:
    hostname: es.deps.internal
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.4
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    environment:
    - node.name=es
    - discovery.type=single-node
    - bootstrap.memory_lock=true
    - "ES_JAVA_OPTS=-Xms128m -Xmx1024m"
    - DISABLE_SECURITY_PLUGIN=true
    - xpack.security.enabled=false
    - xpack.security.transport.ssl.enabled=false
    - xpack.security.http.ssl.enabled=false
    - xpack.watcher.enabled=false
    volumes:
      - es:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.15.1
    environment:
    - http.tls.selfSignedCertificate.disabled=true
    - ELASTICSEARCH_HOSTS=http://es:9200
    - server.host=es
    - xpack.security.authc.providers.anonymous.anonymous1.order=0
    - xpack.security.authc.providers.anonymous.anonymous1.credentials="elasticsearch_anonymous_user"

volumes:
  pgsql: {}
  es: {}
  redis: {}
  registry: {}
