PWD = os.getcwd()

REALM = 'tao'
APPLICATION = 'scoring'

IMAGES = {
    'build/php': 'build/php',
    'build/node': 'build/node18',
    'base/php': 'build/php',
    'base/caddy': 'caddy:2-alpine',
}

ARTIFACTS = {
    'ms-be': '{}/{}/manual/be'.format(REALM,APPLICATION),
    'ms-fe-static': '{}/{}/manual/static'.format(REALM,APPLICATION),
    'ms-fe-bootstrap': '{}/{}/manual/bootstrap'.format(REALM,APPLICATION),
    'ss-be': '{}/{}/service/be'.format(REALM,APPLICATION),
    'hbl-be': '{}/{}/hbl/be'.format(REALM,APPLICATION),
}

PULLS = {}

def build(builder, pwd=PWD,images=IMAGES,pulls=PULLS):
    k8s_yaml(kustomize("{pwd}/manifests".format(pwd=pwd)),)
    watch_file("{pwd}/manifests")
    #k8s_resource( "tao-ce-tao-deliver-be", labels=[APPLICATION])
    #k8s_resource( "tao-ce-tao-deliver-fe-static", labels=[APPLICATION])
    #k8s_resource( "tao-ce-tao-deliver-fe-bootstrap", labels=[APPLICATION])
    #k8s_resource( "tao-ce-tao-deliver-sandbox", labels=[APPLICATION])
    #k8s_resource( "tao-ce-deliver-init", labels=[APPLICATION])


    builder['build'](
        ref=ARTIFACTS['ss-be'],
        context='{pwd}'.format(pwd=pwd),
        build_args={"BASE": IMAGES['build/php'], "BUILD": IMAGES['build/php'], },
        dockerfile='{pwd}/Dockerfile.ss-be'.format(pwd=pwd),
        target="backend",
        image_deps=[ IMAGES['base/php'], IMAGES['build/php'], ],
        ssh="default",
        )
    builder['build'](
        ref=ARTIFACTS['ms-be'],
        context='{pwd}'.format(pwd=pwd),
        build_args={"BASE": IMAGES['build/php'], "BUILD": IMAGES['build/php'], },
        dockerfile='{pwd}/Dockerfile.ms-be'.format(pwd=pwd),
        target="backend",
        image_deps=[ IMAGES['base/php'], IMAGES['build/php'], ],
        ssh="default",
        )
    builder['build'](
        ref=ARTIFACTS['ms-fe-static'],
        context='{pwd}/src/tao-manual-scoring-fe'.format(pwd=pwd),
        build_args={
            "BASE_CADDY": IMAGES['base/caddy'],
            "BASE": IMAGES['build/node'],
            },
        dockerfile='{pwd}/Dockerfile.ms-fe'.format(pwd=pwd),
        target="static",
                secret="id=NPM_TOKEN,src=.secrets/npm",
        )
    builder['build'](
        ref=ARTIFACTS['ms-fe-bootstrap'],
        context='{pwd}/src/tao-manual-scoring-fe'.format(pwd=pwd),
        build_args={"BASE": IMAGES['build/node']},
        dockerfile='{pwd}/Dockerfile.ms-fe'.format(pwd=pwd),
        target="bootstrap",
        image_deps=[ IMAGES['build/node' ], ],
        secret="id=NPM_TOKEN,src=.secrets/npm",
        )