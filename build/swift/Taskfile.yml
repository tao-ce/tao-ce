version: '3'

vars:
  GCR: europe-west1-docker.pkg.dev
  GCP_PROJECT: tao-ce
  # REGISTRY: early-adopters
  IMAGE: tao-ce

  TAO_VERSION:
    sh: echo $TAO_VERSION

  CE_MINOR:
    sh: echo $CE_MINOR

  CE_MAJOR:
    sh: echo $CE_MAJOR

  ARCH: "{{ARCH}}"

  CE_VERSION: "v{{ .CE_MAJOR }}.{{ .CE_MINOR }}"
  MANIFEST_TAG: "{{ .TAO_VERSION }}-{{ .CE_VERSION }}"
  IMAGE_TAG: "{{ .IMAGE_TAG }}-{{ .ARCH }}"

  FULL_REGISTRY: "{{ .GCR }}/{{ .GCP_PROJECT }}/{{ .REGISTRY }}"
  FULL_IMAGE: "{{ .FULL_REGISTRY }}/{{ .IMAGE }}"

  FULL_MANIFEST_URL: "{{ .FULL_IMAGE }}:{{ .MANIFEST_TAG }}"
  FULL_IMAGE_URL: "{{ .FULL_MANIFEST_URL }}-{{ .ARCH }}"

  DEV_TAG: dev-latest
  LOCAL_IMAGE_URL: localhost/{{ .GCP_PROJECT }}/{{ .IMAGE }}:{{ .DEV_TAG }}

  GOOGLE_TOKEN_FILE: .secrets/google_token

tasks:
  info:
    cmds:
    - pwd

  login:
    preconditions:
      - sh: test -f {{ .GOOGLE_TOKEN_FILE }}
        msg: missing {{ .GOOGLE_TOKEN_FILE }}
    cmds:
    - |
      podman login \
        -u  oauth2accesstoken \
        --password-stdin {{ .GCR }} \
          <{{ .GOOGLE_TOKEN_FILE }}

      skopeo login \
        -u  oauth2accesstoken \
        --password-stdin {{ .GCR }} \
          <{{ .GOOGLE_TOKEN_FILE }}

  tag:
    preconditions:
      - sh: test -n "$CE_MINOR"
      - sh: test -n "$CE_MAJOR"
      - sh: test -n "$TAO_VERSION"
    requires:
      vars:
      - name: ARCH
        enum: [arm64, amd64]
    cmds:
    - |
      podman tag \
        {{ .LOCAL_IMAGE_URL }} \
        {{ .FULL_IMAGE_URL }}
  
  push:
    requires:
      vars:
      - CE_MINOR
      - CE_MAJOR
      - TAO_VERSION
    deps:
      - task: login
    cmds:
    - |
      podman push \
        {{ .FULL_IMAGE_URL }}

  manifest:
    requires:
      vars:
      - CE_MINOR
      - CE_MAJOR
      - TAO_VERSION
    deps:
      - task: login
    cmds:
    - |
      podman manifest create -a \
        {{ .FULL_MANIFEST_URL }} \
        {{ .FULL_MANIFEST_URL }}-amd64 \
        {{ .FULL_MANIFEST_URL }}-arm64
      
      podman push \
        {{ .FULL_MANIFEST_URL }}

