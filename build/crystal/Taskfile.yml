version: '3'

vars:
  NAMESPACE: '{{ .NAMESPACE | default "apps" }}'
  DEFAULT_IMAGE: '{{.REGISTRY}}{{if ne .NAMESPACE "-" }}/{{.NAMESPACE}}{{ end }}/{{.APP}}'
  DEFAULT_TARGET: export
  SIGNAL_DIR: '{{.ROOT_SIGNAL_DIR}}/{{.NAMESPACE}}/{{.APP}}'
  VERSION_DIR: '{{.CACHE_DIR}}/versions'
  BUILD_SIGNAL_FILE: "{{.SIGNAL_DIR}}/{{.TAG}}/build/done"
  DEPLOY_SIGNAL_FILE: "{{.SIGNAL_DIR}}/{{.TAG}}/deploy/done"
  START_SIGNAL_FILE: "{{.SIGNAL_DIR}}/{{.TAG}}/start/done"

tasks:
  _log:
    internal: true
    silent: true
    ignore_error: true

    run: always
    cmd: |
      logger --journald <<EOF
      MESSAGE={{.MESSAGE}}
      APP={{.APP}}
      TIER={{.TIER | default "@task" }}
      EOF

  up:
    method: none
    cmds:
    - task: deploy
    - task: start

  gitref:
    method: none
    vars:
      CONTEXTS_LIST:  '{{ keys .CONTEXTS | join "," }}'
    cmds:
    - rm -f {{.VERSION_DIR}}/{{.APP}}
    - mkdir -p {{.VERSION_DIR}}
    - cmd: |
        cat  >>{{.VERSION_DIR}}/{{.APP}} <<EOF
        {{.APP}}:
          context: {{relPath .ROOT_DIR .TASK_DIR}}/{{.CONTEXT}}
          contexts:
        EOF
    - for:
        var: CONTEXTS_LIST
        split: ","
      cmd: |
        cat  >>{{.VERSION_DIR}}/{{.APP}} <<EOF
            {{.ITEM}}:
              path: {{relPath .ROOT_DIR .TASK_DIR}}/{{get .CONTEXTS .ITEM}}
              gitref: $(cd {{get .CONTEXTS .ITEM}}/ &&  git rev-parse HEAD)
              short: $(cd {{get .CONTEXTS .ITEM}}/ &&  git rev-parse --short HEAD)
              origin: $(cd {{get .CONTEXTS .ITEM}}/ &&  git remote get-url origin)
        EOF

  build:
    # desc: Build {{ .IMAGE }}:{{ .TAG }}
    run: always
    vars:
      CONTEXT: '{{ .CONTEXT | default "." }}'
      SUDO: '{{ .SUDO | default "" }}'
      TARGET: '{{ .TARGET | default .DEFAULT_TARGET }}'
      IMAGE: '{{ .IMAGE | default .DEFAULT_IMAGE }}'
    sources:
    - "{{if eq .TASK_DIR .ROOT_DIR}}@@@@@{{else}}{{.TASK_DIR}}/**{{end}}"
    # - exclude: "**/.*"
    generates:
    - "{{.BUILD_SIGNAL_FILE}}"
    status:
    - >
      {{.SUDO}} podman image inspect
      --format {{"{{.Id}}"}}
      $(cat {{.BUILD_SIGNAL_FILE}})
    requires:
      vars:
        - TAG
        - APP
        - NAMESPACE
        - IMAGE
        - TARGET
        - REGISTRY

    set:
    - pipefail

    cmds:
    - |
      echo IMAGE: {{.IMAGE}}
      echo TAG: {{.TAG}}
    - task: _log
      vars:
        MESSAGE: "Starting build image {{.IMAGE}}:{{.TAG}} from {{ .TASK_DIR }}"

    - |
      {{.SUDO}} buildah build \
        -t {{.IMAGE}}:{{.TAG}} \
        {{if .TARGET -}}--target {{.TARGET}}{{- end}} \
        {{if .FILE -}}-f {{.FILE}}{{- end}} \
        --layers \
      {{range $name, $value := .ARGS -}}
      {{" "}}  --build-arg {{ $name }}={{ $value }} 
      {{- end}} \
      {{range $ctx, $path := .CONTEXTS -}}
      {{" "}}  --build-context {{ $ctx }}={{ $path }}
      {{- end}} \
      {{ .BUILD_COMMON_FLAGS | join " " }} \
      {{.CONTEXT}} \
      2>&1  \
      | while read line ; do
      logger --journald <<EOF
      MESSAGE=$line
      APP={{.APP}}
      IMAGE={{.IMAGE}}
      TIER=@build
      EOF
      done
    - mkdir -p $(dirname {{.BUILD_SIGNAL_FILE}})
    - >
      {{.SUDO}} podman image inspect
      --format {{"{{.Id}}"}}
      {{.IMAGE}}:{{.TAG}}
      | head -n1 > {{.BUILD_SIGNAL_FILE}}
    - task: _log
      vars:
        MESSAGE: "Finished build image {{.IMAGE}}:{{.TAG}}"


  deploy:
    aliases: [export]
    vars:
      DIR: '/opt/tao-ce/{{.APP}}'
      IMAGE: '{{ .IMAGE | default .DEFAULT_IMAGE }}'

    # sources:
    #   - "{{ .BUILD_SIGNAL_FILE }}"
    # generates:
    #   - "{{ .DEPLOY_SIGNAL_FILE }}"
    #   - "{{.DIR}}/meta/deploy/done"
    deps: [build]

    status:
      - test "$(cat {{ .DEPLOY_SIGNAL_FILE }} )" == "$(cat {{ .BUILD_SIGNAL_FILE }} )"
      - test "$(cat {{.DIR}}/meta/deploy/done )" == "$(cat {{ .BUILD_SIGNAL_FILE }} )"

    cmds:
    - task: _log
      vars:
        MESSAGE: "Start export from image {{.IMAGE}}:{{.TAG}} to {{.DIR}}"
    - mkdir -p "{{.DIR}}"
    - |
      podman unshare bash -eu -o pipefail -c '
      mnt=$(podman image mount "{{.IMAGE}}:{{.TAG}}");
      rsync -al "$mnt"/ "{{.DIR}}"/;
      podman image umount "{{.IMAGE}}:{{.TAG}}";
      ' 2>&1 \
      | while read line ; do
      logger --journald <<EOF
      MESSAGE=$line
      APP={{.APP}}
      IMAGE={{.IMAGE}}
      TIER=@export
      EOF
      done
    - |
      mkdir -p $(dirname {{.DEPLOY_SIGNAL_FILE}}) "{{.DIR}}/meta/deploy"
      cp {{.BUILD_SIGNAL_FILE}} {{.DEPLOY_SIGNAL_FILE}}
      cp {{.BUILD_SIGNAL_FILE}} "{{.DIR}}/meta/deploy/done"
    - task: _log
      vars:
        MESSAGE: "Finished export from image {{.IMAGE}}:{{.TAG}} to {{.DIR}}"

  clean-start:
    ignore_error: true
    cmds:
    - rm -f {{.START_SIGNAL_FILE}}

  start:
    vars:
      DIR: '/opt/tao-ce/{{.APP}}'
    sources:
      - "{{.DEPLOY_SIGNAL_FILE}}"
    status:
      - test "$(cat {{ .DEPLOY_SIGNAL_FILE }} )" == "$(cat {{ .START_SIGNAL_FILE }} )"

    generates:
      - "{{.START_SIGNAL_FILE}}"
    deps: [export]
    ignore_error: true
    
    cmds:
    - task: _log
      vars:
        MESSAGE: Starting {{.APP}}...
    - |
      sudo systemctl daemon-reload
      sudo systemctl enable --force {{.DIR}}/meta/systemd/*.service
      sudo systemctl restart --all "tao-ce.{{.APP}}*.service"
      mkdir -p $(dirname {{.START_SIGNAL_FILE}})
      cp {{.DEPLOY_SIGNAL_FILE}} {{.START_SIGNAL_FILE}}
    - task: _log
      vars:
        MESSAGE: Started {{.APP}}
