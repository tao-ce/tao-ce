version: '3'

method: checksum

tasks:
  build:bootc:
    set:
      - pipefail
    cmds:
    - |
      mkdir -p .cache/artifacts/cozy
      date -Iminutes --utc | cut -f1 -d+ | tr ':' '-' >.cache/artifacts/cozy/TS
      sudo -E podman run \
        --rm \
        -it \
        --privileged \
        --pull=newer \
        -v ./build/cozy/config/bootc.toml:/config.toml:ro \
        -v ./.cache/artifacts/cozy:/output \
        -v  /var/lib/containers/storage:/var/lib/containers/storage \
        quay.io/centos-bootc/bootc-image-builder:latest \
          --type qcow2 \
          --rootfs xfs \
          --chown $(id -u):$(id -g) \
          --log-level debug \
          -vv \
          --use-librepo \
          localhost/tao-ce/tao-ce-vm:dev-latest \
      | while read line ; do
      logger --journald <<EOF
      MESSAGE=$line
      APP=vm
      TIER=@build
      EOF
      done

  build:vmdk:
    sources:
      - .cache/artifacts/cozy/qcow2/disk.qcow2
    generates:
      - .cache/artifacts/cozy/disk.vmdk
    cmds:
    - |
      qemu-img convert \
        -f qcow2 \
        .cache/artifacts/cozy/qcow2/disk.qcow2 \
        -O vmdk \
        .cache/artifacts/cozy/disk.vmdk

  build:ova:
    vars:
      IMAGE_NAME: tao-ce-cozy
      COZY_DIR: .cache/artifacts/cozy
      VMDK_FILE: '{{.COZY_DIR}}/disk.vmdk'
      OVA_FILE: '{{.COZY_DIR}}/{{.IMAGE_NAME}}.ova'
      OVF_FILE: '{{.COZY_DIR}}/{{.IMAGE_NAME}}.ovf'
      SHA_FILE: '{{.COZY_DIR}}/{{.IMAGE_NAME}}.mf'
      DISK_CAPACITY:
        sh: |
          qemu-img info --output json {{.VMDK_FILE}} | jq '.["virtual-size"]'
      DISK_UUID:
        sh: cat /proc/sys/kernel/random/uuid
      MACHINE_UUID:
        sh: cat /proc/sys/kernel/random/uuid
      VM_MANIFEST:
        map:
          disk:
            file: disk.vmdk
            capacity: '{{.DISK_CAPACITY}}'
            uuid: '{{.DISK_UUID}}'
          machine:
            uuid: '{{.MACHINE_UUID}}'
      VM_MANIFEST_ARGS: '{{.VM_MANIFEST | toJson }}'

    cmds:
    - |
      jsonnet -S \
        --tla-code args='{{.VM_MANIFEST_ARGS}}' \
        build/cozy/config/vm.ovf.jsonnet \
          >{{.OVF_FILE}}
    - |
      pushd .cache/artifacts/cozy
      sha256sum --tag \
        $(basename {{.VMDK_FILE}}) \
        $(basename {{.OVF_FILE}}) \
          > $(basename {{.SHA_FILE}})
      tar cf \
        $(basename {{.OVA_FILE}}) \
        $(basename {{.OVF_FILE}}) \
        $(basename {{.VMDK_FILE}}) \
        $(basename {{.SHA_FILE}})

  push:ova:
    vars:
      IMAGE_NAME: tao-ce-cozy
      COZY_DIR: .cache/artifacts/cozy
      OVA_FILE: '{{.COZY_DIR}}/{{.IMAGE_NAME}}.ova'

    cmds:
    - |
      gcloud \
        --access-token-file=.secrets/google_token \
          storage cp \
            {{.OVA_FILE}} \
            gs://tao-ce-build/cozy/{{ARCH}}/$(cat .cache/artifacts/cozy/TS)/$(basename {{.OVA_FILE}})
