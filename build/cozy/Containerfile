ARG FEDORA_VERSION=42
ARG FEDORA_FLAVOR=quay.io/fedora-ostree-desktops/kinoite
ARG REGISTRY_KEY=early-adopters-registry.json
ARG TAO_DOMAIN="tao-community-edition.local"

ARG OS_VARIANT="TAO Community Edition - Cozy"
ARG OS_VARIANT_ID="com.taotesting.cozy"

FROM node:24 AS build-cockpit

ENV NODE_ENV=production
WORKDIR /app
COPY src/cockpit-tao-ce/ /app/
RUN \
    --mount=type=cache,id=npm-cache,target=/root/.npm,sharing=locked \
    make


FROM ${FEDORA_FLAVOR}:${FEDORA_VERSION} AS base

ARG TARGETPLATFORM
ARG TARGETOS
ARG TARGETARCH
ARG FEDORA_VERSION
ARG FEDORA_FLAVOR
ARG OS_VARIANT
ARG OS_VARIANT_ID

ARG TIMEZONE="UTC"
ARG TAO_DOMAIN
ARG REGISTRY_KEY

LABEL org.opencontainers.image.authors="opensource-support@taotesting.com"

RUN dnf -y swap fedora-release generic-release --allowerasing \
    && dnf -y remove kdeconnectd  kde-connect \
    && echo 'VARIANT="${OS_VARIANT}"' >>/usr/lib/os-release \
    && echo 'VARIANT_ID="${OS_VARIANT_ID}"' >>/usr/lib/os-release

COPY --from=secrets /${REGISTRY_KEY} /etc/tao-ce/auth/registry.json

RUN \
    --mount=type=cache,id=dnf-cache,target=/var/cache/dnf \
    --mount=type=cache,id=libdnf-cache,target=/var/cache/libdnf5 \
    --mount=type=bind,target=/run/context/packages.lst,source=config/packages.lst \
    cat /run/context/packages.lst \
        | grep -v '^#' \
        | grep -v '^[ ]*$' \
        | xargs \
            dnf \
                --setopt=install_weak_deps=false \
                install -y

RUN \
    --mount=type=bind,target=/run/context/images.lst,source=config/images.lst \
    cat /run/context/images.lst \
        | grep -v '^#' \
        | grep -v '^[ ]*$' \
        | xargs -n1 \
            podman pull

COPY root/ /
COPY --from=build-cockpit /app/dist/ /usr/share/cockpit/tao-ce/

RUN \
    ln -s /usr/share/zoneinfo/${TIMEZONE} /etc/localtime \
    && systemctl enable \
        sshd.service \
        avahi-daemon.service \
    && dnf clean all

FROM base AS vm

FROM base AS pi

RUN \
    --mount=type=cache,id=dnf-cache,target=/var/cache/dnf \
    --mount=type=cache,id=libdnf-cache,target=/var/cache/libdnf5 \
    dnf install -y uboot-images-armv8  bcm2711-firmware  bcm283x-firmware bcm283x-overlays \
    && dnf clean all